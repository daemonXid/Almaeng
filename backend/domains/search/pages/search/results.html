{% extends "base.html" %}
{% load i18n %}
{% load humanize %}
{% load search_tags %}

{% block title %}{{ result.query }} ê²€ìƒ‰ ê²°ê³¼ | AI ì‡¼í•‘ ë„ìš°ë¯¸{% endblock %}

{% block head %}
<!-- JSON-LD Structured Data -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "SearchResultsPage",
  "name": "{{ result.query }} ê²€ìƒ‰ ê²°ê³¼",
  "description": "{{ result.recommendation|default:result.query }}",
  "numberOfItems": {{ result.products|length }},
  "mainEntity": {
    "@type": "ItemList",
    "itemListElement": [
      {% for product in result.products|slice:":10" %}
      {
        "@type": "ListItem",
        "position": {{ forloop.counter }},
        "item": {
          "@type": "Product",
          "name": "{{ product.name|escapejs }}",
          "image": "{{ product.image_url }}",
          "offers": {
            "@type": "Offer",
            "price": "{{ product.price }}",
            "priceCurrency": "KRW",
            "availability": "https://schema.org/InStock",
            "url": "{{ product.product_url }}"
          }
        }
      }{% if not forloop.last %},{% endif %}
      {% endfor %}
    ]
  }
}
</script>
{% endblock %}

{% block content %}
<main class="min-h-screen bg-[#FAFAF9] pb-24 font-sans" 
    x-data="{ viewMode: localStorage.getItem('searchViewMode') || 'list' }" 
    x-init="$watch('viewMode', val => localStorage.setItem('searchViewMode', val))"
    x-id="['search-results']">
    <div :class="viewMode === 'grid' ? 'max-w-4xl' : 'max-w-xl'" class="mx-auto px-5 pt-6 transition-all duration-300">
        <!-- Header -->
        <header class="sticky top-0 z-30 bg-white/95 backdrop-blur-sm border-b border-gray-200 -mx-5 px-5 py-4 mb-4">
            <a href="/"
                class="text-brand-600 hover:text-brand-700 flex items-center gap-2 mb-3 text-sm">
                <span>â†</span> í™ˆìœ¼ë¡œ
            </a>
            <h1 class="text-lg font-bold text-gray-800">
                ğŸ” "{{ result.query }}"
            </h1>
            
        </header>

        <!-- AI Recommendation -->
        {% if result.recommendation and result.products %}
        <section class="mb-6">
            <div class="bg-gradient-to-r from-emerald-50 to-teal-50 border border-emerald-200 rounded-2xl p-4">
                <div class="flex items-start gap-3">
                    <span class="text-2xl">âœ¨</span>
                    <div class="flex-1">
                        <p class="text-sm font-bold text-emerald-800 mb-1">ê²€ìƒ‰ ê²°ê³¼</p>
                        <p class="text-sm text-gray-700 leading-relaxed">
                            {{ result.recommendation }}
                        </p>
                        {% if result.cheapest %}
                        <p class="text-xs text-emerald-600 font-medium mt-2">
                            ğŸ’° ìµœì €ê°€: {{ result.cheapest.price|floatformat:0|intcomma }}ì› ({{ result.cheapest.platform|upper }})
                        </p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </section>
        {% endif %}

        <!-- Price Comparison -->
        <section class="mb-6">
            <div class="flex flex-col gap-3 mb-3">
                <div class="flex justify-between items-center">
                    <h2 class="text-base font-bold text-gray-800 dark:text-white">ğŸ“Š ê°€ê²© ë¹„êµ</h2>
                    <span class="text-xs text-gray-500">ì´ {{ total_products }}ê°œ{% if page > 1 and total_products > 0 %} ({{ start_idx|add:1 }}-{{ end_idx }} í‘œì‹œ){% endif %}</span>
                </div>
                
                <!-- Filters and View Toggle -->
                <div class="flex flex-wrap items-center gap-2">
                    <!-- Sort Filter -->
                    <select 
                        @change="window.location.href = '{% url 'search:search' %}?q={{ result.query|urlencode }}&sort=' + $event.target.value + '{% if filter_platform %}&platform={{ filter_platform }}{% endif %}'"
                        class="text-xs px-3 py-1.5 bg-white border border-gray-200 rounded-lg text-gray-700 focus:ring-2 focus:ring-brand-400">
                        <option value="price" {% if sort_by == "price" %}selected{% endif %}>ğŸ’° ê°€ê²©ìˆœ</option>
                        <option value="rating" {% if sort_by == "rating" %}selected{% endif %}>â­ í‰ì ìˆœ</option>
                        <option value="name" {% if sort_by == "name" %}selected{% endif %}>ğŸ”¤ ì´ë¦„ìˆœ</option>
                    </select>
                    
                    <!-- Platform Filter -->
                    <select
                        @change="window.location.href = '{% url 'search:search' %}?q={{ result.query|urlencode }}&sort={{ sort_by }}&platform=' + ($event.target.value ? $event.target.value : '')"
                        class="text-xs px-3 py-1.5 bg-white border border-gray-200 rounded-lg text-gray-700 focus:ring-2 focus:ring-brand-400">
                        <option value="">ğŸ›’ ì „ì²´ í”Œë«í¼</option>
                        <option value="naver" {% if filter_platform == "naver" %}selected{% endif %}>ë„¤ì´ë²„</option>
                        <option value="11st" {% if filter_platform == "11st" %}selected{% endif %}>11ë²ˆê°€</option>
                        <option value="coupang" {% if filter_platform == "coupang" %}selected{% endif %}>ì¿ íŒ¡</option>
                    </select>
                    
                    <!-- View Toggle -->
                    <div class="flex items-center gap-1 bg-gray-100 rounded-lg p-1 ml-auto">
                        <button @click="viewMode = 'list'; localStorage.setItem('searchViewMode', 'list')" 
                            :class="viewMode === 'list' ? 'bg-white text-brand-600 shadow-sm' : 'text-gray-500'"
                            class="px-2 py-1 rounded text-xs font-medium transition-all"
                            title="ë¦¬ìŠ¤íŠ¸ ë³´ê¸°">
                            ğŸ“‹
                        </button>
                        <button @click="viewMode = 'grid'; localStorage.setItem('searchViewMode', 'grid')"
                            :class="viewMode === 'grid' ? 'bg-white text-brand-600 shadow-sm' : 'text-gray-500'"
                            class="px-2 py-1 rounded text-xs font-medium transition-all"
                            title="ê·¸ë¦¬ë“œ ë³´ê¸°">
                            â–¦
                        </button>
                    </div>
                </div>
            </div>

            {% if error %}
            <div class="p-4 bg-red-50 border border-red-200 rounded-xl mb-4">
                <div class="flex items-start gap-3">
                    <span class="text-xl">âš ï¸</span>
                    <div>
                        <p class="text-sm font-medium text-red-800 dark:text-red-200 mb-1">ì˜¤ë¥˜ ë°œìƒ</p>
                        <p class="text-sm text-red-600 dark:text-red-400">{{ error }}</p>
                        <button onclick="window.location.reload()" 
                            class="mt-2 text-xs text-red-600 dark:text-red-400 hover:underline font-medium">
                            ë‹¤ì‹œ ì‹œë„ â†’
                        </button>
                    </div>
                </div>
            </div>
            {% endif %}

            {% if result.products %}
            <!-- Cheapest Product (Always shown) -->
            {% if result.cheapest %}
            <article itemscope itemtype="https://schema.org/Product"
                class="bg-white dark:bg-gray-800 border-2 border-brand-400 rounded-2xl p-4 shadow-sm relative group mb-4">
                <div class="absolute top-4 right-4 z-10">
                    {% with product_id=result.cheapest.id|stringformat:"s" %}
                    {% include "wishlist/pages/index/_wishlist_button.html" with product=result.cheapest
                    is_in_wishlist=product_wishlist_map|get_item:product_id %}
                    {% endwith %}
                </div>
                <div class="flex items-center gap-2 mb-2">
                    <span class="px-2 py-0.5 bg-brand-100 text-brand-700 text-xs font-bold rounded-full">ğŸ·ï¸
                        ìµœì €ê°€</span>
                    <span class="text-xs text-gray-500">{{ result.cheapest.platform|upper }}</span>
                </div>
                <div class="flex gap-3">
                    {% if result.cheapest.image_url %}
                    <img src="{{ result.cheapest.image_url }}" alt="{{ result.cheapest.name }}"
                        class="w-20 h-20 object-cover rounded-lg bg-gray-100 flex-shrink-0">
                    {% endif %}
                        <div class="flex-1 min-w-0">
                            <h3 itemprop="name" class="text-sm font-medium text-gray-800 dark:text-white line-clamp-2 mb-1">
                                {{ result.cheapest.name }}
                            </h3>
                            <div itemprop="offers" itemscope itemtype="https://schema.org/Offer">
                                <p itemprop="price" content="{{ result.cheapest.price }}" class="text-lg font-bold text-brand-600">
                                    â‚©{{ result.cheapest.price|floatformat:0|intcomma }}
                                </p>
                                <meta itemprop="priceCurrency" content="KRW">
                                <meta itemprop="availability" content="https://schema.org/InStock">
                            </div>
                        {% if result.cheapest.mall_name %}
                        <p class="text-xs text-gray-500">{{ result.cheapest.mall_name }}</p>
                        {% endif %}
                    </div>
                </div>
                <div class="mt-3">
                    <a href="{% url 'search:track_click' %}?id={{ result.cheapest.id }}&name={{ result.cheapest.name|urlencode }}&price={{ result.cheapest.price }}&image={{ result.cheapest.image_url|urlencode }}&url={{ result.cheapest.product_url|urlencode }}"
                        target="_blank" rel="noopener"
                        class="block w-full py-3 text-center text-sm font-bold text-white bg-brand-600 hover:bg-brand-700 rounded-xl transition-colors">
                        ğŸ›’ ìµœì €ê°€ë¡œ êµ¬ë§¤í•˜ê¸°
                    </a>
                </div>
            </article>
            {% endif %}

            <!-- Product Table (Fitshop Style) -->
            <div id="product-list-container" class="space-y-3"
                x-data="{ selectedKeyword: null, sidebarOpen: false }">
                {% include "pages/search/_table_row.html" %}
                
                {% if not result.products %}
                <div class="text-center py-8 text-gray-500">
                    <p class="text-4xl mb-2">ğŸ˜¢</p>
                    <p>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                    <p class="text-sm mt-1">ë‹¤ë¥¸ í‚¤ì›Œë“œë¡œ ê²€ìƒ‰í•´ë³´ì„¸ìš”.</p>
                </div>
                {% endif %}

                <!-- Loading Skeleton (shown during HTMX requests) -->
                <div id="loading-skeleton" class="htmx-indicator space-y-4 mt-4">
                    {% for i in "123" %}
                    <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-4 animate-pulse">
                        <div class="flex gap-3">
                            <div class="w-16 h-16 bg-gray-200 dark:bg-gray-700 rounded-lg"></div>
                            <div class="flex-1 space-y-2">
                                <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-3/4"></div>
                                <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-1/2"></div>
                                <div class="h-3 bg-gray-200 dark:bg-gray-700 rounded w-1/4"></div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Other Products - Grid View -->
            <div id="product-grid-container" x-show="viewMode === 'grid'" class="grid grid-cols-2 gap-3">
                {% include "pages/search/_product_item_grid.html" %}
                
                {% if not result.products %}
                <div class="col-span-2 text-center py-8 text-gray-500">
                    <p class="text-4xl mb-2">ğŸ˜¢</p>
                    <p>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                    <p class="text-sm mt-1">ë‹¤ë¥¸ í‚¤ì›Œë“œë¡œ ê²€ìƒ‰í•´ë³´ì„¸ìš”.</p>
                </div>
                {% endif %}
            </div>
            {% else %}
            <div class="text-center py-12 text-gray-500">
                <p class="text-4xl mb-3">ğŸ”</p>
                <p class="font-medium">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                <p class="text-sm mt-1">ë‹¤ë¥¸ í‚¤ì›Œë“œë¡œ ê²€ìƒ‰í•´ë³´ì„¸ìš”.</p>
            </div>
            {% endif %}
        </section>

        <!-- New Search -->
        <section class="mt-8">
            <form action="{% url 'search:search' %}" method="get" class="relative">
                <input type="text" name="q" placeholder="ë‹¤ë¥¸ ìƒí’ˆ ê²€ìƒ‰..."
                    class="w-full h-12 pl-4 pr-20 rounded-xl bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 focus:ring-2 focus:ring-brand-400 text-sm placeholder-gray-400 text-gray-800 dark:text-white"
                    autocomplete="off" required>
                <button type="submit"
                    class="absolute right-2 top-1/2 -translate-y-1/2 px-4 py-1.5 bg-brand-600 hover:bg-brand-700 text-white text-sm font-bold rounded-lg transition-colors">
                    ê²€ìƒ‰
                </button>
            </form>
        </section>
    </div>
</main>
{% endblock %}