{% extends "base.html" %}
{% load i18n %}
{% load humanize %}

{% block title %}{{ result.query }} ê²€ìƒ‰ ê²°ê³¼ | AI ì‡¼í•‘ ë„ìš°ë¯¸{% endblock %}

{% block content %}
<main class="min-h-screen bg-[#FAFAF9] dark:bg-gray-900 pb-24 font-sans">
    <div class="max-w-xl mx-auto px-5 pt-6">
        <!-- Header -->
        <header class="mb-4">
            <a href="{% url 'daemon:home' %}"
                class="text-brand-600 hover:text-brand-700 flex items-center gap-2 mb-3 text-sm">
                <span>â†</span> í™ˆìœ¼ë¡œ
            </a>
            <h1 class="text-lg font-bold text-gray-800 dark:text-white flex items-center gap-2">
                ğŸ” "{{ result.query }}"
            </h1>
            {% if result.keywords %}
            <p class="text-xs text-gray-500 mt-1">
                í‚¤ì›Œë“œ: {% for kw in result.keywords %}{{ kw }}{% if not forloop.last %}, {% endif %}{% endfor %}
            </p>
            {% endif %}
        </header>

        <!-- AI Recommendation -->
        {% if result.recommendation %}
        <section class="mb-6">
            <div
                class="bg-gradient-to-r from-brand-50 to-indigo-50 dark:from-brand-900/30 dark:to-indigo-900/30 border border-brand-200 dark:border-brand-700 rounded-2xl p-4">
                <div class="flex items-start gap-3">
                    <span class="text-2xl">ğŸ¤–</span>
                    <div>
                        <p class="text-sm font-medium text-brand-800 dark:text-brand-200 mb-1">AI ì¶”ì²œ</p>
                        <p class="text-sm text-gray-700 dark:text-gray-300 leading-relaxed">
                            {{ result.recommendation }}
                        </p>
                    </div>
                </div>
            </div>
        </section>
        {% endif %}

        <!-- Price Comparison -->
        <section class="mb-6">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-base font-bold text-gray-800 dark:text-white">ğŸ“Š ê°€ê²© ë¹„êµ</h2>
                <span class="text-xs text-gray-500">ì´ {{ result.products|length }}ê°œ</span>
            </div>

            {% if result.products %}
            <div class="space-y-3">
                <!-- Cheapest Product -->
                {% if result.cheapest %}
                <article
                    class="bg-white dark:bg-gray-800 border-2 border-brand-400 rounded-2xl p-4 shadow-sm relative group">
                    <div class="absolute top-4 right-4 z-10">
                        {% include "wishlist/pages/index/_wishlist_button.html" with product=result.cheapest
                        is_in_wishlist=result.cheapest.id|stringformat:"s" in wishlist_ids %}
                    </div>
                    <div class="flex items-center gap-2 mb-2">
                        <span class="px-2 py-0.5 bg-brand-100 text-brand-700 text-xs font-bold rounded-full">ğŸ·ï¸
                            ìµœì €ê°€</span>
                        <span class="text-xs text-gray-500">{{ result.cheapest.platform|upper }}</span>
                    </div>
                    <div class="flex gap-3">
                        {% if result.cheapest.image_url %}
                        <img src="{{ result.cheapest.image_url }}" alt="{{ result.cheapest.name }}"
                            class="w-20 h-20 object-cover rounded-lg bg-gray-100 flex-shrink-0">
                        {% endif %}
                        <div class="flex-1 min-w-0">
                            <h3 class="text-sm font-medium text-gray-800 dark:text-white line-clamp-2 mb-1">
                                {{ result.cheapest.name }}
                            </h3>
                            <p class="text-lg font-bold text-brand-600">
                                â‚©{{ result.cheapest.price|floatformat:0|intcomma }}
                            </p>
                            {% if result.cheapest.mall_name %}
                            <p class="text-xs text-gray-500">{{ result.cheapest.mall_name }}</p>
                            {% endif %}
                        </div>
                    </div>
                    <div class="flex gap-2 mt-3">
                        <a href="{% url 'search:track_click' %}?id={{ result.cheapest.id }}&name={{ result.cheapest.name|urlencode }}&price={{ result.cheapest.price }}&image={{ result.cheapest.image_url|urlencode }}&url={{ result.cheapest.product_url|urlencode }}"
                            target="_blank" rel="noopener"
                            class="flex-1 py-2 text-center text-sm font-medium text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-xl transition-colors">
                            ìƒí’ˆ ë³´ê¸°
                        </a>
                        <a href="{% url 'billing:checkout' %}?product_id={{ result.cheapest.id }}&platform={{ result.cheapest.platform }}&name={{ result.cheapest.name|urlencode }}&price={{ result.cheapest.price }}&url={{ result.cheapest.product_url|urlencode }}&image={{ result.cheapest.image_url|urlencode }}"
                            class="flex-1 py-2 text-center text-sm font-bold text-white bg-blue-500 hover:bg-blue-600 rounded-xl transition-colors">
                            ğŸ’³ í† ìŠ¤í˜ì´ êµ¬ë§¤
                        </a>
                    </div>
                </article>
                {% endif %}

                <!-- Other Products -->
                {% for product in result.products %}
                {% if product.id != result.cheapest.id %}
                <article
                    class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-2xl p-4 relative group">
                    <div class="absolute top-4 right-4 z-10">
                        {% include "wishlist/pages/index/_wishlist_button.html" with product=product
                        is_in_wishlist=product.id|stringformat:"s" in wishlist_ids %}
                    </div>
                    <div class="flex items-center gap-2 mb-2">
                        <span
                            class="text-xs px-2 py-0.5 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 rounded-full">
                            {{ product.platform|upper }}
                        </span>
                        {% if product.rating %}
                        <span class="text-xs text-yellow-500">â­ {{ product.rating }}</span>
                        {% endif %}
                        {% if product.review_count %}
                        <span class="text-xs text-gray-500">({{ product.review_count }})</span>
                        {% endif %}
                    </div>
                    <div class="flex gap-3">
                        {% if product.image_url %}
                        <img src="{{ product.image_url }}" alt="{{ product.name }}"
                            class="w-16 h-16 object-cover rounded-lg bg-gray-100 flex-shrink-0">
                        {% endif %}
                        <div class="flex-1 min-w-0">
                            <h3 class="text-sm font-medium text-gray-800 dark:text-white line-clamp-2 mb-1">
                                {{ product.name }}
                            </h3>
                            <div class="flex items-baseline gap-2">
                                <p class="text-base font-bold text-gray-800 dark:text-white">
                                    â‚©{{ product.price|floatformat:0|intcomma }}
                                </p>
                                {% if product.original_price and product.discount_rate %}
                                <span class="text-xs text-gray-400 line-through">â‚©{{
                                    product.original_price|floatformat:0|intcomma }}</span>
                                <span class="text-xs text-red-500 font-medium">{{ product.discount_rate }}%</span>
                                {% endif %}
                            </div>
                            {% if product.mall_name %}
                            <p class="text-xs text-gray-500 mt-0.5">{{ product.mall_name }}</p>
                            {% endif %}
                        </div>
                    </div>
                    <div class="flex gap-2 mt-3">
                        <a href="{% url 'search:track_click' %}?id={{ product.id }}&name={{ product.name|urlencode }}&price={{ product.price }}&image={{ product.image_url|urlencode }}&url={{ product.product_url|urlencode }}"
                            target="_blank" rel="noopener"
                            class="flex-1 py-2 text-center text-xs font-medium text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-xl transition-colors">
                            ìƒí’ˆ ë³´ê¸°
                        </a>
                        <a href="{% url 'billing:checkout' %}?product_id={{ product.id }}&platform={{ product.platform }}&name={{ product.name|urlencode }}&price={{ product.price }}&url={{ product.product_url|urlencode }}&image={{ product.image_url|urlencode }}"
                            class="flex-1 py-2 text-center text-xs font-bold text-white bg-blue-500 hover:bg-blue-600 rounded-xl transition-colors">
                            ğŸ’³ êµ¬ë§¤
                        </a>
                    </div>
                </article>
                {% endif %}
                {% empty %}
                <div class="text-center py-8 text-gray-500">
                    <p class="text-4xl mb-2">ğŸ˜¢</p>
                    <p>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                    <p class="text-sm mt-1">ë‹¤ë¥¸ í‚¤ì›Œë“œë¡œ ê²€ìƒ‰í•´ë³´ì„¸ìš”.</p>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-12 text-gray-500">
                <p class="text-4xl mb-3">ğŸ”</p>
                <p class="font-medium">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                <p class="text-sm mt-1">ë‹¤ë¥¸ í‚¤ì›Œë“œë¡œ ê²€ìƒ‰í•´ë³´ì„¸ìš”.</p>
            </div>
            {% endif %}
        </section>

        <!-- New Search -->
        <section class="mt-8">
            <form action="{% url 'search:search' %}" method="get" class="relative">
                <input type="text" name="q" placeholder="ë‹¤ë¥¸ ìƒí’ˆ ê²€ìƒ‰..."
                    class="w-full h-12 pl-4 pr-20 rounded-xl bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 focus:ring-2 focus:ring-brand-400 text-sm placeholder-gray-400 text-gray-800 dark:text-white"
                    autocomplete="off" required>
                <button type="submit"
                    class="absolute right-2 top-1/2 -translate-y-1/2 px-4 py-1.5 bg-brand-600 hover:bg-brand-700 text-white text-sm font-bold rounded-lg transition-colors">
                    ê²€ìƒ‰
                </button>
            </form>
        </section>
    </div>
</main>
{% endblock %}