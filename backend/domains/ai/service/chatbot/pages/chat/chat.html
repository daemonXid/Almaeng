{% extends "_dashboard_base.html" %}

{% block title %}AI Chat | DAEMON-ONE{% endblock %}

{% block dashboard_content %}
<div x-data="chatbot()">
    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
        <div>
            <h1 class="text-3xl font-bold text-slate-800 tracking-tight">AI Assistant</h1>
            <p class="text-slate-500 mt-1">Ask questions about this codebase. I'll help you understand the code.</p>
        </div>
        <div class="flex items-center gap-3">
            <span class="px-4 py-2 bg-purple-50 border border-purple-100 rounded-lg text-sm font-semibold text-purple-600 flex items-center gap-2">
                ğŸ¤– {{ ai_provider|default:'HuggingFace' }}
            </span>
        </div>
    </div>

    <!-- Chat Container -->
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
        <!-- Main Chat Area -->
        <div class="lg:col-span-3">
            <div class="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden flex flex-col" style="height: 600px;">
                <!-- Messages Area -->
                <div id="chat-messages" class="flex-1 overflow-y-auto p-6 space-y-4 custom-scrollbar bg-slate-50">
                    <!-- Welcome message -->
                    <div class="flex gap-3">
                        <div class="w-8 h-8 rounded-lg bg-purple-100 flex items-center justify-center text-purple-600 shrink-0">
                            ğŸ¤–
                        </div>
                        <div class="bg-white p-4 rounded-2xl rounded-tl-none border border-slate-100 shadow-sm max-w-[80%]">
                            <p class="text-slate-700 mb-2">ì•ˆë…•í•˜ì„¸ìš”! ğŸ‘‹</p>
                            <p class="text-slate-600 text-sm">DAEMON-ONE í”„ë¡œì íŠ¸ì— ëŒ€í•´ ì§ˆë¬¸í•´ì£¼ì„¸ìš”.</p>
                            <ul class="mt-3 text-sm text-slate-500 space-y-1">
                                <li>â€¢ "ë„ë©”ì¸ì„ ì–´ë–»ê²Œ ì¶”ê°€í•˜ë‚˜ìš”?"</li>
                                <li>â€¢ "AI ProviderëŠ” ì–´ë–»ê²Œ ì‘ë™í•˜ë‚˜ìš”?"</li>
                                <li>â€¢ "interface.py ì‚¬ìš©ë²•ì„ ì•Œë ¤ì£¼ì„¸ìš”"</li>
                            </ul>
                        </div>
                    </div>
                    
                    <!-- Dynamic messages will be inserted here -->
                    <div id="messages-container"></div>
                </div>

                <!-- Input Area -->
                <div class="p-4 border-t border-slate-100 bg-white" x-data="{ 
                    question: '',
                    isStreaming: false,
                    send() {
                        if(!this.question || this.isStreaming) return;
                        
                        const container = document.getElementById('messages-container');
                        
                        // Add user message
                        const userMsg = document.createElement('div');
                        userMsg.className = 'flex gap-3 justify-end';
                        userMsg.innerHTML = `
                            <div class='bg-indigo-500 text-white p-4 rounded-2xl rounded-tr-none max-w-[80%]'>
                                ${this.question}
                            </div>
                            <div class='w-8 h-8 rounded-lg bg-indigo-100 flex items-center justify-center text-indigo-600 shrink-0'>
                                ğŸ‘¤
                            </div>
                        `;
                        container.appendChild(userMsg);
                        
                        this.isStreaming = true;
                        const encodedQuestion = encodeURIComponent(this.question);
                        this.question = '';
                        scrollToBottom();

                        const eventSource = new EventSource(`/chatbot/stream/?question=${encodedQuestion}`);
                        
                        let assistantMsg = null;
                        let contentDiv = null;

                        eventSource.onmessage = (event) => {
                            if (!assistantMsg) {
                                assistantMsg = document.createElement('div');
                                assistantMsg.className = 'flex gap-3';
                                assistantMsg.innerHTML = `
                                    <div class='w-8 h-8 rounded-lg bg-purple-100 flex items-center justify-center text-purple-600 shrink-0'>ğŸ¤–</div>
                                    <div class='bg-white p-4 rounded-2xl rounded-tl-none border border-slate-100 shadow-sm max-w-[80%]'><div class='message-content text-slate-700'></div></div>
                                `;
                                container.appendChild(assistantMsg);
                                contentDiv = assistantMsg.querySelector('.message-content');
                            }
                            contentDiv.innerHTML += event.data;
                            scrollToBottom();
                        };

                        eventSource.onerror = (err) => {
                            console.error('SSE Error:', err);
                            eventSource.close();
                            this.isStreaming = false;
                        };
                    }
                }">
                    <div class="flex gap-3">
                        <input 
                            type="text" 
                            x-model="question"
                            @keydown.enter="send()"
                            class="flex-1 px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:outline-none focus:border-indigo-500 focus:bg-white transition-all"
                            placeholder="í”„ë¡œì íŠ¸ì— ëŒ€í•´ ë¬¼ì–´ë³´ì„¸ìš”..."
                            :disabled="isStreaming"
                        >
                        <button 
                            @click="send()"
                            class="px-6 py-3 bg-indigo-500 text-white font-bold rounded-xl hover:bg-indigo-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                            :disabled="isStreaming || !question"
                        >
                            <span x-show="!isStreaming">ì „ì†¡ â†’</span>
                            <span x-show="isStreaming">ìƒì„± ì¤‘...</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar - Quick Actions -->
        <div class="space-y-6">
            <!-- Quick Questions -->
            <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm">
                <h3 class="font-bold text-slate-800 mb-4">Quick Questions</h3>
                <div class="space-y-2">
                    <button 
                        class="w-full text-left p-3 bg-slate-50 rounded-xl hover:bg-indigo-50 hover:border-indigo-200 border border-transparent transition-colors text-sm text-slate-600"
                        hx-post="/chatbot/send/"
                        hx-vals='{"question": "ë„ë©”ì¸ êµ¬ì¡°ë¥¼ ì„¤ëª…í•´ì£¼ì„¸ìš”"}'
                        hx-target="#messages-container"
                        hx-swap="beforeend"
                    >
                        ğŸ“¦ ë„ë©”ì¸ êµ¬ì¡°
                    </button>
                    <button 
                        class="w-full text-left p-3 bg-slate-50 rounded-xl hover:bg-indigo-50 hover:border-indigo-200 border border-transparent transition-colors text-sm text-slate-600"
                        hx-post="/chatbot/send/"
                        hx-vals='{"question": "HTMX ì‚¬ìš©ë²•ì„ ì•Œë ¤ì£¼ì„¸ìš”"}'
                        hx-target="#messages-container"
                        hx-swap="beforeend"
                    >
                        âš¡ HTMX ì‚¬ìš©ë²•
                    </button>
                    <button 
                        class="w-full text-left p-3 bg-slate-50 rounded-xl hover:bg-indigo-50 hover:border-indigo-200 border border-transparent transition-colors text-sm text-slate-600"
                        hx-post="/chatbot/send/"
                        hx-vals='{"question": "ì¸ì¦ ì‹œìŠ¤í…œì€ ì–´ë–»ê²Œ ì‘ë™í•˜ë‚˜ìš”?"}'
                        hx-target="#messages-container"
                        hx-swap="beforeend"
                    >
                        ğŸ” ì¸ì¦ ì‹œìŠ¤í…œ
                    </button>
                    <button 
                        class="w-full text-left p-3 bg-slate-50 rounded-xl hover:bg-indigo-50 hover:border-indigo-200 border border-transparent transition-colors text-sm text-slate-600"
                        hx-post="/chatbot/send/"
                        hx-vals='{"question": "AI Provider ì„¤ì • ë°©ë²•ì„ ì•Œë ¤ì£¼ì„¸ìš”"}'
                        hx-target="#messages-container"
                        hx-swap="beforeend"
                    >
                        ğŸ¤– AI Provider
                    </button>
                </div>
            </div>

            <!-- AI Info -->
            <div class="bg-gradient-to-br from-purple-500 to-indigo-600 p-6 rounded-2xl shadow-sm text-white">
                <h3 class="font-bold mb-4">AI Strategy</h3>
                <div class="space-y-3 text-sm">
                    <div class="flex items-center gap-2">
                        <span class="w-2 h-2 bg-white rounded-full"></span>
                        <span>HuggingFace (Free)</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="w-2 h-2 bg-white/50 rounded-full"></span>
                        <span>DeepSeek (Quality)</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="w-2 h-2 bg-white/50 rounded-full"></span>
                        <span>OpenRouter (Multi)</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function scrollToBottom() {
    const container = document.getElementById('chat-messages');
    container.scrollTop = container.scrollHeight;
}

function chatbot() {
    return {};
}
</script>
{% endblock %}
