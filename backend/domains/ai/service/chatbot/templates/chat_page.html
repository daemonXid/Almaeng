{% extends "base.html" %}
{% load i18n %}

{% block content %}
<div class="flex h-[calc(100vh-64px)] overflow-hidden">

    <!-- History Sidebar (Left Panel) -->
    <div
        class="w-80 bg-gray-50 dark:bg-gray-900 border-r border-gray-200 dark:border-gray-800 flex flex-col hidden md:flex">
        <!-- New Chat Button -->
        <div class="p-4">
            <a href="{% url 'ai_chatbot:new_chat' %}"
                class="flex items-center justify-center gap-2 w-full py-3 px-4 bg-emerald-500 hover:bg-emerald-600 text-white rounded-xl transition-colors font-medium shadow-sm">
                <span>+</span> {% trans "ìƒˆ ëŒ€í™”" %}
            </a>
        </div>

        <!-- History List -->
        <div class="flex-1 overflow-y-auto px-2 space-y-1 pb-4">
            {% if sessions %}
            {% for session in sessions %}
            <div
                class="group relative flex items-center gap-2 px-3 py-3 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors cursor-pointer
                            {% if active_session and active_session.id == session.id %}bg-white dark:bg-gray-800 shadow-sm border border-gray-200 dark:border-gray-700{% endif %}">
                <a href="{% url 'ai_chatbot:chat_session' session.id %}" class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-gray-900 dark:text-gray-100 truncate">
                        {{ session.title }}
                    </p>
                    <p class="text-xs text-gray-400 mt-0.5">
                        {{ session.updated_at|date:"m.d H:i" }}
                    </p>
                </a>

                {% if active_session.id != session.id %}
                <button hx-delete="{% url 'ai_chatbot:delete_session' session.id %}"
                    hx-confirm="{% trans 'ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?' %}" hx-target="closest div" hx-swap="outerHTML"
                    class="opacity-0 group-hover:opacity-100 p-1.5 text-gray-400 hover:text-red-500 rounded-lg transition-all">
                    ğŸ—‘ï¸
                </button>
                {% endif %}
            </div>
            {% endfor %}
            {% else %}
            <div class="p-4 text-center text-gray-400 text-sm">
                {% trans "ëŒ€í™” ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤." %}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Chat Interface (Right Panel) -->
    <div class="flex-1 flex flex-col relative bg-white dark:bg-gray-950">

        <!-- Chat Header (Mobile Only / Session Info) -->
        <div class="h-14 border-b border-gray-200 dark:border-gray-800 flex items-center px-4 md:hidden">
            <span class="font-bold text-gray-900 dark:text-white">ALMAENG AI</span>
        </div>

        <!-- Messages Area -->
        <div id="chat-messages" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 scroll-smooth">
            {% if not active_session and not messages %}
            <!-- Empty State -->
            <div class="h-full flex flex-col items-center justify-center text-center opacity-70">
                <div
                    class="w-24 h-24 bg-gradient-to-br from-emerald-100 to-teal-100 dark:from-emerald-900/30 dark:to-teal-900/30 rounded-full flex items-center justify-center mb-6">
                    <img src="/static/images/catch_mascot.png" alt="ìºì¹˜" class="w-16 h-16 object-cover">
                </div>
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?</h2>
                <p class="text-gray-500 max-w-md">ì˜ì–‘ì œ ì„±ë¶„ ë¶„ì„, ë§ì¶¤ ì¶”ì²œ, ê°€ê²© ë¹„êµê¹Œì§€<br>AI ìƒë‹´ì‚¬ ìºì¹˜ê°€ ë„ì™€ë“œë¦´ê²Œìš”!</p>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-8 w-full max-w-2xl px-4">
                    <button
                        class="text-left p-4 rounded-xl border border-gray-200 dark:border-gray-800 hover:border-emerald-500 hover:bg-emerald-50 dark:hover:bg-emerald-900/20 transition-all font-medium text-sm text-gray-600 dark:text-gray-300"
                        onclick="fillInput('ë¹„íƒ€ë¯¼D ì œí’ˆ ì¶”ì²œí•´ì¤˜')">
                        ğŸ’Š ë¹„íƒ€ë¯¼D ì œí’ˆ ì¶”ì²œí•´ì¤˜
                    </button>
                    <button
                        class="text-left p-4 rounded-xl border border-gray-200 dark:border-gray-800 hover:border-emerald-500 hover:bg-emerald-50 dark:hover:bg-emerald-900/20 transition-all font-medium text-sm text-gray-600 dark:text-gray-300"
                        onclick="fillInput('ì˜¤ë©”ê°€3 íš¨ëŠ¥ì´ ë­ì•¼?')">
                        ğŸ” ì˜¤ë©”ê°€3 íš¨ëŠ¥ì´ ë­ì•¼?
                    </button>
                </div>
            </div>
            {% else %}
            <!-- Message History -->
            {% for message in messages %}
            {% include "_message_fragment.html" with user_message=message.content role=message.role
            ai_message=message.content sources=message.sources %}
            {% endfor %}
            {% endif %}
        </div>

        <!-- Input Area (Opaque Background) -->
        <div
            class="p-4 md:p-6 bg-white dark:bg-gray-950 border-t border-gray-100 dark:border-gray-800 absolute bottom-0 left-0 right-0">
            <div class="max-w-4xl mx-auto">
                <form
                    hx-post="{% if active_session %}{% url 'ai_chatbot:send_session' active_session.id %}{% else %}{% url 'ai_chatbot:send_new' %}{% endif %}"
                    hx-target="#chat-messages" hx-swap="beforeend scroll:#chat-messages:bottom"
                    hx-on::after-request="this.reset(); document.getElementById('message-input').focus();"
                    class="relative shadow-lg rounded-2xl bg-white dark:bg-gray-800 border-2 border-transparent focus-within:border-emerald-500 transition-all">
                    {% csrf_token %}
                    <textarea id="message-input" name="message" rows="1" placeholder="{% trans 'ì˜ì–‘ì œì— ëŒ€í•´ ë¬¼ì–´ë³´ì„¸ìš”...' %}"
                        class="w-full pl-4 pr-14 py-4 bg-transparent border-none focus:ring-0 resize-none max-h-32 text-gray-900 dark:text-white placeholder-gray-400"
                        onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); this.form.requestSubmit(); }"></textarea>

                    <button type="submit"
                        class="absolute right-2 bottom-2 p-2 bg-emerald-500 hover:bg-emerald-600 text-white rounded-xl transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                            <path
                                d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z" />
                        </svg>
                    </button>
                </form>
                <div class="text-center mt-2">
                    <p class="text-xs text-gray-400">AIëŠ” ì‹¤ìˆ˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì¤‘ìš”í•œ ê±´ê°• ì •ë³´ëŠ” ë°˜ë“œì‹œ ì „ë¬¸ê°€ì™€ í™•ì¸í•˜ì„¸ìš”.</p>
                </div>
            </div>
        </div>

        <!-- Bottom Padding for Input -->
        <div class="h-32 md:h-40"></div>
    </div>
</div>

<script>
    function fillInput(text) {
        const input = document.getElementById('message-input');
        input.value = text;
        input.focus();
    }
</script>
{% endblock %}